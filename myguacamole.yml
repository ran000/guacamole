---
- name: guacamole
  hosts: "{{ target }}"
  gather_facts: true
  become: true
  tasks:

    - name: Set container_command = podman for rhel8
      set_fact:
        container_command: podman
      when:
        - ansible_os_family == 'RedHat' and ansible_distribution_major_version == "9"
    
    - name: Determine if (One Time) was done
      stat:
        path: /opt/guacamole/one_time_done
      register: guacdb_one_time_done
    
    - name: Guacamole data dir
      file:
        path: /opt/guacamole
        state: directory
        owner: root
        group: root
        mode: '0750'
    
    - name: Determine db passwords set (root)
      stat:
        path: /opt/guacamole/guacdb_root_file
      register: guacdb_root_file

    - name: Determine db passwords set (guacamole)
      stat:
        path: /opt/guacamole/guacdb_guacamole_file
      register: guacdb_guacamole_file

    - name: Create db passwords when not set (root)
      shell: |
        head /dev/urandom | tr -dc A-Za-z0-9 | head -c 20 > /opt/guacamole/guacdb_root_file
      when: guacdb_root_file.stat.exists|bool == False

    - name: Create db passwords when not set (guacamole)
      shell: |
        head /dev/urandom | tr -dc A-Za-z0-9 | head -c 20 > /opt/guacamole/guacdb_guacamole_file
      when: guacdb_guacamole_file.stat.exists|bool == False

    - name: Register db passwords
      shell: |
        cat /opt/guacamole/guacdb_root_file
      register: guacdb_root_pass

    - name: Register db pass (guacamole)
      shell: |
        cat /opt/guacamole/guacdb_guacamole_file
      register: guacdb_guacamole_pass

    - name: Docker Volume (db)
      shell: |
        {{ container_command }} volume create guacdb
      when: guacdb_one_time_done.stat.exists|bool == False
      ignore_errors: true
    
    - name: Docker Pod
      shell: |
        {{ container_command }} pod create -p 8080:8080 guacpod
      when: guacdb_one_time_done.stat.exists|bool == False
      ignore_errors: true

    - name: Container Launch - podman
      shell: |
        {{ container_command }} run -d --name guacd --pod guacpod docker.io/guacamole/guacd
        {{ container_command }} run -d --name guacdb --pod guacpod --volume guacdb:/var/lib/mysql:Z -e MYSQL_ROOT_PASSWORD={{ guacdb_root_pass.stdout }} docker.io/mysql/mysql-server
        {{ container_command }} run -d --name guacamole --pod guacpod -e MYSQL_HOSTNAME=127.0.0.1 -e MYSQL_PORT=3306 -e MYSQL_DATABASE=guacamole_db -e MYSQL_USER=guacamole_user -e MYSQL_PASSWORD={{ guacdb_guacamole_pass.stdout }} -e MYSQL_SSL_MODE=disabled -e GUACD_HOSTNAME=127.0.0.1 -e GUACD_PORT=4822  docker.io/guacamole/guacamole
      when:
        - container_command == 'podman'


    - name: Set my.cnf and dbpass.sql
      template:
        src: "{{ item }}"
        dest: "/opt/guacamole/{{ item }}"
        owner: root
        group: root
        mode: '0400'
      with_items:
        - my.cnf
        - dbpass.sql
      when: guacdb_one_time_done.stat.exists|bool == False

    - name: Wait for mysqld on 3306
      shell: |
        {{ container_command }} logs guacdb 2>&1 | grep --quiet 'port: 3306'
      register: wait_for_mysqld
      until: wait_for_mysqld.rc == 0
      retries: 15
      delay: 15
      when: guacdb_one_time_done.stat.exists|bool == False

    - name: Configure DB (One Time)
      shell: |
        # credentials
        {{ container_command }} cp /opt/guacamole/my.cnf guacdb:/root/.my.cnf
        {{ container_command }} cp /opt/guacamole/dbpass.sql guacdb:dbpass.sql
        {{ container_command }} exec -i guacdb /bin/bash -c "mysql < dbpass.sql"
        touch /opt/guacamole/one_time_done
        # schema
        {{ container_command }} exec -i guacamole /bin/bash -c 'cat /opt/guacamole/mysql/schema/*.sql' > /opt/guacamole/dbschema.sql
        {{ container_command }} cp /opt/guacamole/dbschema.sql guacdb:dbschema.sql
        {{ container_command }} exec -i guacdb /bin/bash -c "mysql guacamole_db < dbschema.sql"
      when: guacdb_one_time_done.stat.exists|bool == False
